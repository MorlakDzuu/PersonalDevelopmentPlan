# Разобраться с Group SQL запросами и аггрегационными функциями

## __Оператор GROUP BY__ ##

Служит для распределения строк - результата запроса - по группам, в которых значения некоторого столбца, по которому происходит группировка, являются одинаковыми. Группировку можно производить как по одному столбцу, так и по нескольким.

_Структура запроса:_
 ```sql 
 SELECT [литералы, агрегатные_функции, поля_группировки]
 FROM имя_таблицы
 GROUP BY поля_группировки;
```

 ## __Агрегатные функции__ ##

Агрегатная функция – это функция, которая выполняет вычисление на наборе значений и возвращает одиночное значение.
Применяются для значений, не равных NULL, исключение COUNT(*)

_Структура запроса:_
```sql
SELECT [литералы, агрегатные_функции, поля_группировки]
FROM имя_таблицы
GROUP BY поля_группировки;
```

**Доступные функции** 
| <!-- -->                           | <!-- -->                           |
|------------------------------------|------------------------------------|
| SUM(поле_таблицы)                  | *Возвращает сумму значений*        |
| AVG(поле_таблицы)                  | *Возвращает среднее значение*      |
| COUNT(поле_таблицы)                | *Возвращает количество записей*    |
| MIN(поле_таблицы)                  | *Возвращает минимальное значение*  |
| MAX(поле_таблицы)                  | *Возвращает максимальное значение* |

 ## __Оператор HAVING__ ##

Для фильтрации групп нельзя использовать оператор WHERE, так как в момент его исполнения он ничего про группы не знает.

_Структура запроса:_
```sql
SELECT [константы, агрегатные_функции, поля_группировки]
FROM имя_таблицы
WHERE условия_на_ограничения_строк
GROUP BY поля_группировки
HAVING условие_на_ограничение_строк_после_группировки
ORDER BY условие_сортировки
```

# __Задание__

## __Условие__ ##
Источники у которых больше всего отзывов с ответами (Источник, количество отзывов за последние 2 года, средняя оценка, количество ответов на отзывы), только те источники у котрых, больше 10000 отзывов (используюя HAVING)

## __Решение__ ##

```sql
  SELECT SourceKind,
  COUNT(ReviewId) as ReviewCount,
  AVG(PercentRate * 10) as AverageScore,
  COUNT(ReviewResponseId) as ResponseCount
  FROM [reputation].[dbo].[Review] as t1
  JOIN [reputation].[dbo].[ReviewRate] as t2
  ON t1.ReviewGuid = t2.ReviewGuid
  LEFT JOIN [reputation].[dbo].[ReviewResponse] as t3
  ON t1.ReviewGuid = t3.ReviewGuid
  WHERE t1.Date > DATEADD(year,-2,GETDATE())
  GROUP BY SourceKind
  HAVING COUNT(ReviewId) > 10000
  ORDER BY SourceKind
```

| SourceKind |	ReviewCount	  | AverageScore	| ResponseCount |
|------------|----------------|-----------------|---------------|
| 1	         |   314330	      | 8.593839	    | 75619         |
| 2	         |   27095	      | 8.475290	    | 15607         |
| 6          |   181925	      | 8.786459	    | 7930          |
| 12	     |   71084	      | 8.839513	    | 15031         |
| 16	     |   295409	      | 8.936064	    | 153638        |
| 20	     |   10143	      | 8.388642	    | 5858          |